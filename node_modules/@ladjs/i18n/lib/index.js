'use strict';

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

var _require = require('path');

const resolve = _require.resolve;

const isEmpty = require('lodash.isempty');
const sortBy = require('lodash.sortby');
const every = require('lodash.every');

var _require2 = require('qs');

const stringify = _require2.stringify;

const Boom = require('boom');
const s = require('underscore.string');

var _require3 = require('country-language');

const getLanguage = _require3.getLanguage;

const moment = require('moment');
const i18n = require('i18n');
const locales = require('i18n-locales');
const autoBind = require('auto-bind');

// expose global
i18n.api = {};

class I18N {
  constructor(config = {}) {
    this.config = Object.assign({
      phrases: {},
      logger: console,
      directory: resolve('locales'),
      locales: ['en', 'es', 'zh'],
      cookie: 'locale',
      indent: '  ',
      defaultLocale: 'en',
      syncFiles: true,
      autoReload: true,
      updateFiles: true,
      api: {
        __: 't',
        __n: 'tn',
        __l: 'tl',
        __h: 'th',
        __mf: 'tmf'
      },
      register: i18n.api
    }, config);

    const logger = this.config.logger;


    this.config.logDebugFn = logger.debug;
    this.config.logWarnFn = logger.warn;
    this.config.logErrorFn = logger.error;

    // validate locales against available ones
    if (!every(this.config.locales, l => locales.includes(l))) throw new Error(`Invalid locales: ${this.config.locales.filter(str => !locales.includes(str)).join(', ')}`);

    // inherit i18n object
    Object.assign(this, i18n);

    // configure i18n
    this.configure(this.config);

    autoBind(this);
  }

  translate(key, locale) {
    var _config = this.config;
    const logger = _config.logger,
          phrases = _config.phrases;

    let args = Object.keys(arguments).map(key => arguments[key]).slice(2);
    if (typeof args === 'undefined') args = [];
    const phrase = phrases[key];
    if (typeof phrase !== 'string') {
      logger.warn(`translation key missing: ${key}`);
      return;
    }
    args = [{ phrase, locale }, ...args];
    return i18n.api.t(...args);
  }

  middleware(ctx, next) {
    var _config2 = this.config;
    const locales = _config2.locales,
          defaultLocale = _config2.defaultLocale,
          phrases = _config2.phrases,
          cookie = _config2.cookie;

    // expose api methods to `ctx.req` and `ctx.state`

    i18n.init(ctx.req, ctx.state);

    // override the existing locale detection with our own
    // in order of priority:
    //
    // 1. check the URL, if === `/de` or starts with `/de/` then locale is `de`
    // 2. check the cookie
    // 3. check Accept-Language last
    //
    // also we need to expose `ctx.pathWithoutLocale`
    // as the path without locale

    let locale = locales.find(l => {
      return `/${l}` === ctx.path || ctx.path.indexOf(`/${l}/`) === 0;
    });

    ctx.pathWithoutLocale = locale ? ctx.path.substring(`/${locale}`.length) : ctx.path;
    if (ctx.pathWithoutLocale === '') ctx.pathWithoutLocale = '/';

    if (!locale) {
      locale = defaultLocale;
      if (ctx.cookies.get(cookie) && locales.includes(ctx.cookies.get(cookie))) locale = ctx.cookies.get(cookie);else if (ctx.request.acceptsLanguages(locales)) locale = ctx.request.acceptsLanguages(locales);
    }

    // set the locale properly
    i18n.setLocale([ctx.req, ctx.state], locale);

    // if the locale was not available then redirect user
    if (locale !== ctx.state.locale) return ctx.redirect(`/${ctx.state.locale}${ctx.pathWithoutLocale}${isEmpty(ctx.query) ? '' : `?${stringify(ctx.query)}`}`);

    // available languages for a dropdown menu to change language
    ctx.state.availableLanguages = sortBy(locales.map(locale => {
      return {
        locale,
        url: `/${locale}${ctx.pathWithoutLocale}${isEmpty(ctx.query) ? '' : `?${stringify(ctx.query)}`}`,
        name: getLanguage(locale).name[0]
      };
    }), 'name');

    // get the name of the current locale's language in native language
    ctx.state.currentLanguage = s.titleize(getLanguage(ctx.req.locale).nativeName[0]);

    // bind `ctx.translate` as a helper func
    // so you can pass `ctx.translate('SOME_KEY_IN_CONFIG');` and it will lookup
    // `phrases['SOMETHING']` to get a specific and constant message
    // and then it will call `t` to translate it to the user's locale
    ctx.translate = function () {
      if (typeof arguments[0] !== 'string' || typeof phrases[arguments[0]] !== 'string') return ctx.throw(Boom.badRequest('Translation for your locale failed, try again'));
      arguments[0] = phrases[arguments[0]];
      return ctx.req.t(...arguments);
    };

    return next();
  }

  redirect(ctx, next) {
    var _this = this;

    return _asyncToGenerator(function* () {
      // inspired by nodejs.org language support
      // <https://github.com/nodejs/nodejs.org/commit/d6cdd942a8fc0fffcf6879eca124295e95991bbc#diff-78c12f5adc1848d13b1c6f07055d996eR59>
      const locale = ctx.url.split('/')[1].split('?')[0];
      const hasLang = _this.config.locales.includes(locale);

      // if the URL did not have a valid language found
      // then redirect the user to their detected locale
      if (!hasLang) {
        ctx.status = 302;
        let redirect = `/${ctx.req.locale}${ctx.url}`;
        if (!isEmpty(ctx.query)) redirect += `?${stringify(ctx.query)}`;
        return ctx.redirect(redirect);
      }

      // set the cookie for future requests
      ctx.cookies.set(_this.config.cookie, locale, {
        signed: true,
        expires: moment().add(1, 'year').toDate()
      });

      // if the user is logged in, then save it as `last_locale`
      if (ctx.isAuthenticated()) {
        ctx.state.user.last_locale = locale;
        try {
          yield ctx.state.user.save();
        } catch (err) {
          _this.config.logger.error(err);
        }
      }

      return next();
    })();
  }
}

module.exports = I18N;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJyZXF1aXJlIiwicmVzb2x2ZSIsImlzRW1wdHkiLCJzb3J0QnkiLCJldmVyeSIsInN0cmluZ2lmeSIsIkJvb20iLCJzIiwiZ2V0TGFuZ3VhZ2UiLCJtb21lbnQiLCJpMThuIiwibG9jYWxlcyIsImF1dG9CaW5kIiwiYXBpIiwiSTE4TiIsImNvbnN0cnVjdG9yIiwiY29uZmlnIiwiT2JqZWN0IiwiYXNzaWduIiwicGhyYXNlcyIsImxvZ2dlciIsImNvbnNvbGUiLCJkaXJlY3RvcnkiLCJjb29raWUiLCJpbmRlbnQiLCJkZWZhdWx0TG9jYWxlIiwic3luY0ZpbGVzIiwiYXV0b1JlbG9hZCIsInVwZGF0ZUZpbGVzIiwiX18iLCJfX24iLCJfX2wiLCJfX2giLCJfX21mIiwicmVnaXN0ZXIiLCJsb2dEZWJ1Z0ZuIiwiZGVidWciLCJsb2dXYXJuRm4iLCJ3YXJuIiwibG9nRXJyb3JGbiIsImVycm9yIiwibCIsImluY2x1ZGVzIiwiRXJyb3IiLCJmaWx0ZXIiLCJzdHIiLCJqb2luIiwiY29uZmlndXJlIiwidHJhbnNsYXRlIiwia2V5IiwibG9jYWxlIiwiYXJncyIsImtleXMiLCJhcmd1bWVudHMiLCJtYXAiLCJzbGljZSIsInBocmFzZSIsInQiLCJtaWRkbGV3YXJlIiwiY3R4IiwibmV4dCIsImluaXQiLCJyZXEiLCJzdGF0ZSIsImZpbmQiLCJwYXRoIiwiaW5kZXhPZiIsInBhdGhXaXRob3V0TG9jYWxlIiwic3Vic3RyaW5nIiwibGVuZ3RoIiwiY29va2llcyIsImdldCIsInJlcXVlc3QiLCJhY2NlcHRzTGFuZ3VhZ2VzIiwic2V0TG9jYWxlIiwicmVkaXJlY3QiLCJxdWVyeSIsImF2YWlsYWJsZUxhbmd1YWdlcyIsInVybCIsIm5hbWUiLCJjdXJyZW50TGFuZ3VhZ2UiLCJ0aXRsZWl6ZSIsIm5hdGl2ZU5hbWUiLCJ0aHJvdyIsImJhZFJlcXVlc3QiLCJzcGxpdCIsImhhc0xhbmciLCJzdGF0dXMiLCJzZXQiLCJzaWduZWQiLCJleHBpcmVzIiwiYWRkIiwidG9EYXRlIiwiaXNBdXRoZW50aWNhdGVkIiwidXNlciIsImxhc3RfbG9jYWxlIiwic2F2ZSIsImVyciIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7ZUFBb0JBLFFBQVEsTUFBUixDOztNQUFaQyxPLFlBQUFBLE87O0FBQ1IsTUFBTUMsVUFBVUYsUUFBUSxnQkFBUixDQUFoQjtBQUNBLE1BQU1HLFNBQVNILFFBQVEsZUFBUixDQUFmO0FBQ0EsTUFBTUksUUFBUUosUUFBUSxjQUFSLENBQWQ7O2dCQUNzQkEsUUFBUSxJQUFSLEM7O01BQWRLLFMsYUFBQUEsUzs7QUFDUixNQUFNQyxPQUFPTixRQUFRLE1BQVIsQ0FBYjtBQUNBLE1BQU1PLElBQUlQLFFBQVEsbUJBQVIsQ0FBVjs7Z0JBQ3dCQSxRQUFRLGtCQUFSLEM7O01BQWhCUSxXLGFBQUFBLFc7O0FBQ1IsTUFBTUMsU0FBU1QsUUFBUSxRQUFSLENBQWY7QUFDQSxNQUFNVSxPQUFPVixRQUFRLE1BQVIsQ0FBYjtBQUNBLE1BQU1XLFVBQVVYLFFBQVEsY0FBUixDQUFoQjtBQUNBLE1BQU1ZLFdBQVdaLFFBQVEsV0FBUixDQUFqQjs7QUFFQTtBQUNBVSxLQUFLRyxHQUFMLEdBQVcsRUFBWDs7QUFFQSxNQUFNQyxJQUFOLENBQVc7QUFDVEMsY0FBWUMsU0FBUyxFQUFyQixFQUF5QjtBQUN2QixTQUFLQSxNQUFMLEdBQWNDLE9BQU9DLE1BQVAsQ0FDWjtBQUNFQyxlQUFTLEVBRFg7QUFFRUMsY0FBUUMsT0FGVjtBQUdFQyxpQkFBV3JCLFFBQVEsU0FBUixDQUhiO0FBSUVVLGVBQVMsQ0FBQyxJQUFELEVBQU8sSUFBUCxFQUFhLElBQWIsQ0FKWDtBQUtFWSxjQUFRLFFBTFY7QUFNRUMsY0FBUSxJQU5WO0FBT0VDLHFCQUFlLElBUGpCO0FBUUVDLGlCQUFXLElBUmI7QUFTRUMsa0JBQVksSUFUZDtBQVVFQyxtQkFBYSxJQVZmO0FBV0VmLFdBQUs7QUFDSGdCLFlBQUksR0FERDtBQUVIQyxhQUFL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LFdBQVksSUFBR2hCLElBQUlHLEdBQUosQ0FBUVosTUFBTyxHQUFFUyxJQUFJbUIsR0FBSSxFQUE1QztBQUNBLFlBQUksQ0FBQzVFLFFBQVF5RCxJQUFJaUIsS0FBWixDQUFMLEVBQXlCRCxZQUFhLElBQUd0RSxVQUFVc0QsSUFBSWlCLEtBQWQsQ0FBcUIsRUFBckM7QUFDekIsZUFBT2pCLElBQUlnQixRQUFKLENBQWFBLFFBQWIsQ0FBUDtBQUNEOztBQUVEO0FBQ0FoQixVQUFJVyxPQUFKLENBQVlrQixHQUFaLENBQWdCLE1BQUt4RSxNQUFMLENBQVlPLE1BQTVCLEVBQW9DMkIsTUFBcEMsRUFBNEM7QUFDMUN1QyxnQkFBUSxJQURrQztBQUUxQ0MsaUJBQVNqRixTQUNOa0YsR0FETSxDQUNGLENBREUsRUFDQyxNQURELEVBRU5DLE1BRk07QUFGaUMsT0FBNUM7O0FBT0E7QUFDQSxVQUFJakMsSUFBSWtDLGVBQUosRUFBSixFQUEyQjtBQUN6QmxDLFlBQUlJLEtBQUosQ0FBVStCLElBQVYsQ0FBZUMsV0FBZixHQUE2QjdDLE1BQTdCO0FBQ0EsWUFBSTtBQUNGLGdCQUFNUyxJQUFJSSxLQUFKLENBQVUrQixJQUFWLENBQWVFLElBQWYsRUFBTjtBQUNELFNBRkQsQ0FFRSxPQUFPQyxHQUFQLEVBQVk7QUFDWixnQkFBS2pGLE1BQUwsQ0FBWUksTUFBWixDQUFtQm9CLEtBQW5CLENBQXlCeUQsR0FBekI7QUFDRDtBQUNGOztBQUVELGFBQU9yQyxNQUFQO0FBakN3QjtBQWtDekI7QUFwTFE7O0FBdUxYc0MsT0FBT0MsT0FBUCxHQUFpQnJGLElBQWpCIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyByZXNvbHZlIH0gPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCBpc0VtcHR5ID0gcmVxdWlyZSgnbG9kYXNoLmlzZW1wdHknKTtcbmNvbnN0IHNvcnRCeSA9IHJlcXVpcmUoJ2xvZGFzaC5zb3J0YnknKTtcbmNvbnN0IGV2ZXJ5ID0gcmVxdWlyZSgnbG9kYXNoLmV2ZXJ5Jyk7XG5jb25zdCB7IHN0cmluZ2lmeSB9ID0gcmVxdWlyZSgncXMnKTtcbmNvbnN0IEJvb20gPSByZXF1aXJlKCdib29tJyk7XG5jb25zdCBzID0gcmVxdWlyZSgndW5kZXJzY29yZS5zdHJpbmcnKTtcbmNvbnN0IHsgZ2V0TGFuZ3VhZ2UgfSA9IHJlcXVpcmUoJ2NvdW50cnktbGFuZ3VhZ2UnKTtcbmNvbnN0IG1vbWVudCA9IHJlcXVpcmUoJ21vbWVudCcpO1xuY29uc3QgaTE4biA9IHJlcXVpcmUoJ2kxOG4nKTtcbmNvbnN0IGxvY2FsZXMgPSByZXF1aXJlKCdpMThuLWxvY2FsZXMnKTtcbmNvbnN0IGF1dG9CaW5kID0gcmVxdWlyZSgnYXV0by1iaW5kJyk7XG5cbi8vIGV4cG9zZSBnbG9iYWxcbmkxOG4uYXBpID0ge307XG5cbmNsYXNzIEkxOE4ge1xuICBjb25zdHJ1Y3Rvcihjb25maWcgPSB7fSkge1xuICAgIHRoaXMuY29uZmlnID0gT2JqZWN0LmFzc2lnbihcbiAgICAgIHtcbiAgICAgICAgcGhyYXNlczoge30sXG4gICAgICAgIGxvZ2dlcjogY29uc29sZSxcbiAgICAgICAgZGlyZWN0b3J5OiByZXNvbHZlKCdsb2NhbGVzJyksXG4gICAgICAgIGxvY2FsZXM6IFsnZW4nLCAnZXMnLCAnemgnXSxcbiAgICAgICAgY29va2llOiAnbG9jYWxlJyxcbiAgICAgICAgaW5kZW50OiAnICAnLFxuICAgICAgICBkZWZhdWx0TG9jYWxlOiAnZW4nLFxuICAgICAgICBzeW5jRmlsZXM6IHRydWUsXG4gICAgICAgIGF1dG9SZWxvYWQ6IHRydWUsXG4gICAgICAgIHVwZGF0ZUZpbGVzOiB0cnVlLFxuICAgICAgICBhcGk6IHtcbiAgICAgICAgICBfXzogJ3QnLFxuICAgICAgICAgIF9fbjogJ3RuJyxcbiAgICAgICAgICBfX2w6ICd0bCcsXG4gICAgICAgICAgX19oOiAndGgnLFxuICAgICAgICAgIF9fbWY6ICd0bWYnXG4gICAgICAgIH0sXG4gICAgICAgIHJlZ2lzdGVyOiBpMThuLmFwaVxuICAgICAgfSxcbiAgICAgIGNvbmZpZ1xuICAgICk7XG5cbiAgICBjb25zdCB7IGxvZ2dlciB9ID0gdGhpcy5jb25maWc7XG5cbiAgICB0aGlzLmNvbmZpZy5sb2dEZWJ1Z0ZuID0gbG9nZ2VyLmRlYnVnO1xuICAgIHRoaXMuY29uZmlnLmxvZ1dhcm5GbiA9IGxvZ2dlci53YXJuO1xuICAgIHRoaXMuY29uZmlnLmxvZ0Vycm9yRm4gPSBsb2dnZXIuZXJyb3I7XG5cbiAgICAvLyB2YWxpZGF0ZSBsb2NhbGVzIGFnYWluc3QgYXZhaWxhYmxlIG9uZXNcbiAgICBpZiAoIWV2ZXJ5KHRoaXMuY29uZmlnLmxvY2FsZXMsIGwgPT4gbG9jYWxlcy5pbmNsdWRlcyhsKSkpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBJbnZhbGlkIGxvY2FsZXM6ICR7dGhpcy5jb25maWcubG9jYWxlc1xuICAgICAgICAgIC5maWx0ZXIoc3RyID0+ICFsb2NhbGVzLmluY2x1ZGVzKHN0cikpXG4gICAgICAgICAgLmpvaW4oJywgJyl9YFxuICAgICAgKTtcblxuICAgIC8vIGluaGVyaXQgaTE4biBvYmplY3RcbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIGkxOG4pO1xuXG4gICAgLy8gY29uZmlndXJlIGkxOG5cbiAgICB0aGlzLmNvbmZpZ3VyZSh0aGlzLmNvbmZpZyk7XG5cbiAgICBhdXRvQmluZCh0aGlzKTtcbiAgfVxuXG4gIHRyYW5zbGF0ZShrZXksIGxvY2FsZSkge1xuICAgIGNvbnN0IHsgbG9nZ2VyLCBwaHJhc2VzIH0gPSB0aGlzLmNvbmZpZztcbiAgICBsZXQgYXJncyA9IE9iamVjdC5rZXlzKGFyZ3VtZW50cylcbiAgICAgIC5tYXAoa2V5ID0+IGFyZ3VtZW50c1trZXldKVxuICAgICAgLnNsaWNlKDIpO1xuICAgIGlmICh0eXBlb2YgYXJncyA9PT0gJ3VuZGVmaW5lZCcpIGFyZ3MgPSBbXTtcbiAgICBjb25zdCBwaHJhc2UgPSBwaHJhc2VzW2tleV07XG4gICAgaWYgKHR5cGVvZiBwaHJhc2UgIT09ICdzdHJpbmcnKSB7XG4gICAgICBsb2dnZXIud2FybihgdHJhbnNsYXRpb24ga2V5IG1pc3Npbmc6ICR7a2V5fWApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBhcmdzID0gW3sgcGhyYXNlLCBsb2NhbGUgfSwgLi4uYXJnc107XG4gICAgcmV0dXJuIGkxOG4uYXBpLnQoLi4uYXJncyk7XG4gIH1cblxuICBtaWRkbGV3YXJlKGN0eCwgbmV4dCkge1xuICAgIGNvbnN0IHsgbG9jYWxlcywgZGVmYXVsdExvY2FsZSwgcGhyYXNlcywgY29va2llIH0gPSB0aGlzLmNvbmZpZztcblxuICAgIC8vIGV4cG9zZSBhcGkgbWV0aG9kcyB0byBgY3R4LnJlcWAgYW5kIGBjdHguc3RhdGVgXG4gICAgaTE4bi5pbml0KGN0eC5yZXEsIGN0eC5zdGF0ZSk7XG5cbiAgICAvLyBvdmVycmlkZSB0aGUgZXhpc3RpbmcgbG9jYWxlIGRldGVjdGlvbiB3aXRoIG91ciBvd25cbiAgICAvLyBpbiBvcmRlciBvZiBwcmlvcml0eTpcbiAgICAvL1xuICAgIC8vIDEuIGNoZWNrIHRoZSBVUkwsIGlmID09PSBgL2RlYCBvciBzdGFydHMgd2l0aCBgL2RlL2AgdGhlbiBsb2NhbGUgaXMgYGRlYFxuICAgIC8vIDIuIGNoZWNrIHRoZSBjb29raWVcbiAgICAvLyAzLiBjaGVjayBBY2NlcHQtTGFuZ3VhZ2UgbGFzdFxuICAgIC8vXG4gICAgLy8gYWxzbyB3ZSBuZWVkIHRvIGV4cG9zZSBgY3R4LnBhdGhXaXRob3V0TG9jYWxlYFxuICAgIC8vIGFzIHRoZSBwYXRoIHdpdGhvdXQgbG9jYWxlXG5cbiAgICBsZXQgbG9jYWxlID0gbG9jYWxlcy5maW5kKGwgPT4ge1xuICAgICAgcmV0dXJuIGAvJHtsfWAgPT09IGN0eC5wYXRoIHx8IGN0eC5wYXRoLmluZGV4T2YoYC8ke2x9L2ApID09PSAwO1xuICAgIH0pO1xuXG4gICAgY3R4LnBhdGhXaXRob3V0TG9jYWxlID0gbG9jYWxlXG4gICAgICA/IGN0eC5wYXRoLnN1YnN0cmluZyhgLyR7bG9jYWxlfWAubGVuZ3RoKVxuICAgICAgOiBjdHgucGF0aDtcbiAgICBpZiAoY3R4LnBhdGhXaXRob3V0TG9jYWxlID09PSAnJykgY3R4LnBhdGhXaXRob3V0TG9jYWxlID0gJy8nO1xuXG4gICAgaWYgKCFsb2NhbGUpIHtcbiAgICAgIGxvY2FsZSA9IGRlZmF1bHRMb2NhbGU7XG4gICAgICBpZiAoY3R4LmNvb2tpZXMuZ2V0KGNvb2tpZSkgJiYgbG9jYWxlcy5pbmNsdWRlcyhjdHguY29va2llcy5nZXQoY29va2llKSkpXG4gICAgICAgIGxvY2FsZSA9IGN0eC5jb29raWVzLmdldChjb29raWUpO1xuICAgICAgZWxzZSBpZiAoY3R4LnJlcXVlc3QuYWNjZXB0c0xhbmd1YWdlcyhsb2NhbGVzKSlcbiAgICAgICAgbG9jYWxlID0gY3R4LnJlcXVlc3QuYWNjZXB0c0xhbmd1YWdlcyhsb2NhbGVzKTtcbiAgICB9XG5cbiAgICAvLyBzZXQgdGhlIGxvY2FsZSBwcm9wZXJseVxuICAgIGkxOG4uc2V0TG9jYWxlKFtjdHgucmVxLCBjdHguc3RhdGVdLCBsb2NhbGUpO1xuXG4gICAgLy8gaWYgdGhlIGxvY2FsZSB3YXMgbm90IGF2YWlsYWJsZSB0aGVuIHJlZGlyZWN0IHVzZXJcbiAgICBpZiAobG9jYWxlICE9PSBjdHguc3RhdGUubG9jYWxlKVxuICAgICAgcmV0dXJuIGN0eC5yZWRpcmVjdChcbiAgICAgICAgYC8ke2N0eC5zdGF0ZS5sb2NhbGV9JHtjdHgucGF0aFdpdGhvdXRMb2NhbGV9JHtpc0VtcHR5KGN0eC5xdWVyeSlcbiAgICAgICAgICA/ICcnXG4gICAgICAgICAgOiBgPyR7c3RyaW5naWZ5KGN0eC5xdWVyeSl9YH1gXG4gICAgICApO1xuXG4gICAgLy8gYXZhaWxhYmxlIGxhbmd1YWdlcyBmb3IgYSBkcm9wZG93biBtZW51IHRvIGNoYW5nZSBsYW5ndWFnZVxuICAgIGN0eC5zdGF0ZS5hdmFpbGFibGVMYW5ndWFnZXMgPSBzb3J0QnkoXG4gICAgICBsb2NhbGVzLm1hcChsb2NhbGUgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGxvY2FsZSxcbiAgICAgICAgICB1cmw6IGAvJHtsb2NhbGV9JHtjdHgucGF0aFdpdGhvdXRMb2NhbGV9JHtpc0VtcHR5KGN0eC5xdWVyeSlcbiAgICAgICAgICAgID8gJydcbiAgICAgICAgICAgIDogYD8ke3N0cmluZ2lmeShjdHgucXVlcnkpfWB9YCxcbiAgICAgICAgICBuYW1lOiBnZXRMYW5ndWFnZShsb2NhbGUpLm5hbWVbMF1cbiAgICAgICAgfTtcbiAgICAgIH0pLFxuICAgICAgJ25hbWUnXG4gICAgKTtcblxuICAgIC8vIGdldCB0aGUgbmFtZSBvZiB0aGUgY3VycmVudCBsb2NhbGUncyBsYW5ndWFnZSBpbiBuYXRpdmUgbGFuZ3VhZ2VcbiAgICBjdHguc3RhdGUuY3VycmVudExhbmd1YWdlID0gcy50aXRsZWl6ZShcbiAgICAgIGdldExhbmd1YWdlKGN0eC5yZXEubG9jYWxlKS5uYXRpdmVOYW1lWzBdXG4gICAgKTtcblxuICAgIC8vIGJpbmQgYGN0eC50cmFuc2xhdGVgIGFzIGEgaGVscGVyIGZ1bmNcbiAgICAvLyBzbyB5b3UgY2FuIHBhc3MgYGN0eC50cmFuc2xhdGUoJ1NPTUVfS0VZX0lOX0NPTkZJRycpO2AgYW5kIGl0IHdpbGwgbG9va3VwXG4gICAgLy8gYHBocmFzZXNbJ1NPTUVUSElORyddYCB0byBnZXQgYSBzcGVjaWZpYyBhbmQgY29uc3RhbnQgbWVzc2FnZVxuICAgIC8vIGFuZCB0aGVuIGl0IHdpbGwgY2FsbCBgdGAgdG8gdHJhbnNsYXRlIGl0IHRvIHRoZSB1c2VyJ3MgbG9jYWxlXG4gICAgY3R4LnRyYW5zbGF0ZSA9IGZ1bmN0aW9uKCkge1xuICAgICAgaWYgKFxuICAgICAgICB0eXBlb2YgYXJndW1lbnRzWzBdICE9PSAnc3RyaW5nJyB8fFxuICAgICAgICB0eXBlb2YgcGhyYXNlc1thcmd1bWVudHNbMF1dICE9PSAnc3RyaW5nJ1xuICAgICAgKVxuICAgICAgICByZXR1cm4gY3R4LnRocm93KFxuICAgICAgICAgIEJvb20uYmFkUmVxdWVzdCgnVHJhbnNsYXRpb24gZm9yIHlvdXIgbG9jYWxlIGZhaWxlZCwgdHJ5IGFnYWluJylcbiAgICAgICAgKTtcbiAgICAgIGFyZ3VtZW50c1swXSA9IHBocmFzZXNbYXJndW1lbnRzWzBdXTtcbiAgICAgIHJldHVybiBjdHgucmVxLnQoLi4uYXJndW1lbnRzKTtcbiAgICB9O1xuXG4gICAgcmV0dXJuIG5leHQoKTtcbiAgfVxuXG4gIGFzeW5jIHJlZGlyZWN0KGN0eCwgbmV4dCkge1xuICAgIC8vIGluc3BpcmVkIGJ5IG5vZGVqcy5vcmcgbGFuZ3VhZ2Ugc3VwcG9ydFxuICAgIC8vIDxodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGVqcy5vcmcvY29tbWl0L2Q2Y2RkOTQyYThmYzBmZmZjZjY4NzllY2ExMjQyOTVlOTU5OTFiYmMjZGlmZi03OGMxMmY1YWRjMTg0OGQxM2IxYzZmMDcwNTVkOTk2ZVI1OT5cbiAgICBjb25zdCBsb2NhbGUgPSBjdHgudXJsLnNwbGl0KCcvJylbMV0uc3BsaXQoJz8nKVswXTtcbiAgICBjb25zdCBoYXNMYW5nID0gdGhpcy5jb25maWcubG9jYWxlcy5pbmNsdWRlcyhsb2NhbGUpO1xuXG4gICAgLy8gaWYgdGhlIFVSTCBkaWQgbm90IGhhdmUgYSB2YWxpZCBsYW5ndWFnZSBmb3VuZFxuICAgIC8vIHRoZW4gcmVkaXJlY3QgdGhlIHVzZXIgdG8gdGhlaXIgZGV0ZWN0ZWQgbG9jYWxlXG4gICAgaWYgKCFoYXNMYW5nKSB7XG4gICAgICBjdHguc3RhdHVzID0gMzAyO1xuICAgICAgbGV0IHJlZGlyZWN0ID0gYC8ke2N0eC5yZXEubG9jYWxlfSR7Y3R4LnVybH1gO1xuICAgICAgaWYgKCFpc0VtcHR5KGN0eC5xdWVyeSkpIHJlZGlyZWN0ICs9IGA/JHtzdHJpbmdpZnkoY3R4LnF1ZXJ5KX1gO1xuICAgICAgcmV0dXJuIGN0eC5yZWRpcmVjdChyZWRpcmVjdCk7XG4gICAgfVxuXG4gICAgLy8gc2V0IHRoZSBjb29raWUgZm9yIGZ1dHVyZSByZXF1ZXN0c1xuICAgIGN0eC5jb29raWVzLnNldCh0aGlzLmNvbmZpZy5jb29raWUsIGxvY2FsZSwge1xuICAgICAgc2lnbmVkOiB0cnVlLFxuICAgICAgZXhwaXJlczogbW9tZW50KClcbiAgICAgICAgLmFkZCgxLCAneWVhcicpXG4gICAgICAgIC50b0RhdGUoKVxuICAgIH0pO1xuXG4gICAgLy8gaWYgdGhlIHVzZXIgaXMgbG9nZ2VkIGluLCB0aGVuIHNhdmUgaXQgYXMgYGxhc3RfbG9jYWxlYFxuICAgIGlmIChjdHguaXNBdXRoZW50aWNhdGVkKCkpIHtcbiAgICAgIGN0eC5zdGF0ZS51c2VyLmxhc3RfbG9jYWxlID0gbG9jYWxlO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgY3R4LnN0YXRlLnVzZXIuc2F2ZSgpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRoaXMuY29uZmlnLmxvZ2dlci5lcnJvcihlcnIpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuZXh0KCk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBJMThOO1xuIl19